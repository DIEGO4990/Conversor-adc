#include <WiFi.h>
#include <esp_now.h>
#include <Preferences.h>


#define POT_PIN 34
#define RESET_BTN 0 Â // BotÃ£o BOOT do ESP32


Preferences prefs;
uint8_t peerMac[6];
bool macValido = false;


void solicitarMac() {
Â  Serial.println("Digite o MAC destino (formato: AA:BB:CC:DD:EE:FF):");
Â  while (!Serial.available());
Â  String input = Serial.readStringUntil('\n');
Â  input.trim();


Â  int valores[6];
Â  if (sscanf(input.c_str(), "%x:%x:%x:%x:%x:%x",
Â  Â  Â  Â  Â  Â  Â &valores[0], &valores[1], &valores[2],
Â  Â  Â  Â  Â  Â  Â &valores[3], &valores[4], &valores[5]) == 6) {
Â  Â  for (int i = 0; i < 6; i++) {
Â  Â  Â  peerMac[i] = (uint8_t)valores[i];
Â  Â  Â  prefs.putUChar(("mac" + String(i)).c_str(), peerMac[i]);
Â  Â  }
Â  Â  macValido = true;
Â  Â  Serial.println("âœ… MAC salvo com sucesso!");
Â  } else {
Â  Â  Serial.println("âŒ MAC invÃ¡lido. Reinicie e tente novamente.");
Â  }
}


void setup() {
Â  Serial.begin(115200);
Â  pinMode(POT_PIN, INPUT);
Â  pinMode(RESET_BTN, INPUT_PULLUP);
Â  WiFi.mode(WIFI_STA);


Â  prefs.begin("macprefs", false);


Â  // Apaga o MAC ao segurar o botÃ£o BOOT
Â  if (digitalRead(RESET_BTN) == LOW) {
Â  Â  prefs.clear();
Â  Â  prefs.end();
Â  Â  Serial.println("ðŸ§¹ MAC apagado. Reinicie para cadastrar novamente.");
Â  Â  while (true);
Â  }


Â  if (prefs.isKey("mac0")) {
Â  Â  for (int i = 0; i < 6; i++) {
Â  Â  Â  peerMac[i] = prefs.getUChar(("mac" + String(i)).c_str(), 0);
Â  Â  }
Â  Â  macValido = true;
Â  } else {
Â  Â  solicitarMac();
Â  }


Â  prefs.end();


Â  if (!macValido) return;


Â  if (esp_now_init() != ESP_OK) {
Â  Â  Serial.println("Erro ao iniciar ESP-NOW");
Â  Â  return;
Â  }


Â  esp_now_peer_info_t peerInfo = {};
Â  memcpy(peerInfo.peer_addr, peerMac, 6);
Â  peerInfo.channel = 0;
Â  peerInfo.encrypt = false;


Â  if (esp_now_add_peer(&peerInfo) != ESP_OK) {
Â  Â  Serial.println("Erro ao adicionar peer");
Â  Â  return;
Â  }


Â  Serial.println("ðŸš€ Pronto para enviar comandos via ESP-NOW");
}


void loop() {
Â  if (!macValido) return;


Â  int leitura = analogRead(POT_PIN);
Â  const char* comando = (leitura > 2000) ? "LED_ON" : "LED_OFF";


Â  esp_now_send(peerMac, (const uint8_t*)comando, strlen(comando));
Â  delay(250);
}
